#!/bin/bash
# cruzAlex Setup Wizard
# Interactive post-installation configuration

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
BOLD='\033[1m'
NC='\033[0m'

CRUZALEX_DIR="${CRUZALEX_DIR:-$HOME/.config/cruzalex}"
THEMES_DIR="$CRUZALEX_DIR/themes"

# Helper functions
print_header() {
    clear
    echo -e "${CYAN}"
    cat << 'EOF'
   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïó     ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïó
  ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ïö‚ïê‚ïê‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïù
  ‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ñà‚ïî‚ïù ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó   ‚ïö‚ñà‚ñà‚ñà‚ïî‚ïù
  ‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë ‚ñà‚ñà‚ñà‚ïî‚ïù  ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù   ‚ñà‚ñà‚ïî‚ñà‚ñà‚ïó
  ‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïù ‚ñà‚ñà‚ïó
   ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù
EOF
    echo -e "${NC}"
    echo -e "${BOLD}  Setup Wizard${NC}"
    echo ""
}

print_step() {
    echo -e "\n${BLUE}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo -e "${BOLD}  $1${NC}"
    echo -e "${BLUE}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}\n"
}

print_success() {
    echo -e "${GREEN}  ‚úì $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}  ‚ö† $1${NC}"
}

print_info() {
    echo -e "${CYAN}  ‚Ñπ $1${NC}"
}

press_enter() {
    echo ""
    read -p "  Press Enter to continue..."
}

# Step 1: Welcome
step_welcome() {
    print_header
    echo -e "  Welcome to cruzAlex Linux setup!"
    echo ""
    echo -e "  This wizard will help you configure:"
    echo -e "    ${CYAN}1.${NC} Select your default theme"
    echo -e "    ${CYAN}2.${NC} Set up Spotify integration"
    echo -e "    ${CYAN}3.${NC} Configure keyboard shortcuts"
    echo -e "    ${CYAN}4.${NC} Show you the essential keybindings"
    echo ""
    echo -e "  ${YELLOW}Note:${NC} You can run this wizard again anytime with:"
    echo -e "        ${BOLD}cruzalex-setup${NC}"
    press_enter
}

# Step 2: Theme Selection
step_theme() {
    print_header
    print_step "Step 1: Choose Your Theme"

    # Get list of installed themes
    local themes=()
    if [ -d "$THEMES_DIR" ]; then
        for dir in "$THEMES_DIR"/*/; do
            if [ -d "$dir" ]; then
                local name=$(basename "$dir")
                [ "$name" != "current" ] && themes+=("$name")
            fi
        done
    fi

    if [ ${#themes[@]} -eq 0 ]; then
        print_warning "No themes installed yet."
        echo ""
        echo -e "  You can browse and install themes with:"
        echo -e "    ${BOLD}cruzalex-themes${NC}"
        echo ""
        echo -e "  Or install one now from the Omarchy collection:"
        echo ""
        read -p "  Install cobalt2 theme now? (Y/n) " -n 1 -r
        echo ""
        if [[ ! $REPLY =~ ^[Nn]$ ]]; then
            echo ""
            echo -e "  ${CYAN}Downloading cobalt2 theme...${NC}"
            mkdir -p "$THEMES_DIR"
            if git clone --depth 1 https://github.com/hoblin/omarchy-cobalt2-theme.git "$THEMES_DIR/cobalt2" 2>/dev/null; then
                print_success "cobalt2 theme installed"
                themes=("cobalt2")
            else
                print_warning "Could not download theme. Check your internet connection."
                press_enter
                return
            fi
        else
            press_enter
            return
        fi
    fi

    # Show theme selection
    echo -e "  Available themes:\n"
    local i=1
    for theme in "${themes[@]}"; do
        local marker=""
        if [ -L "$CRUZALEX_DIR/current" ]; then
            local current=$(readlink "$CRUZALEX_DIR/current" | xargs basename)
            [ "$theme" = "$current" ] && marker=" ${GREEN}(current)${NC}"
        fi
        echo -e "    ${CYAN}$i)${NC} $theme$marker"
        ((i++))
    done
    echo ""

    read -p "  Select theme number (or press Enter to skip): " selection

    if [ -n "$selection" ] && [ "$selection" -ge 1 ] 2>/dev/null && [ "$selection" -le ${#themes[@]} ]; then
        local selected_theme="${themes[$((selection-1))]}"
        echo ""
        echo -e "  ${CYAN}Applying theme: $selected_theme${NC}"

        if command -v cruzalex-theme-set &> /dev/null; then
            cruzalex-theme-set "$selected_theme"
            print_success "Theme '$selected_theme' applied!"
        else
            # Manual symlink if script not found
            ln -sfn "$THEMES_DIR/$selected_theme" "$CRUZALEX_DIR/current"
            print_success "Theme '$selected_theme' set as current"
            print_info "Run theme hooks to fully apply: cruzalex-theme-set $selected_theme"
        fi
    else
        print_info "Skipping theme selection"
    fi

    press_enter
}

# Step 3: Spotify Setup
step_spotify() {
    print_header
    print_step "Step 2: Spotify Integration (Optional)"

    echo -e "  cruzAlex includes ${BOLD}spotify_player${NC} - a TUI Spotify client."
    echo ""
    echo -e "  To use it, you need a Spotify Premium account and a"
    echo -e "  Developer App (free to create)."
    echo ""

    read -p "  Do you want to set up Spotify? (y/N) " -n 1 -r
    echo ""

    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        print_info "Skipping Spotify setup"
        press_enter
        return
    fi

    echo ""
    echo -e "  ${BOLD}Step 1: Create a Spotify Developer App${NC}"
    echo ""
    echo -e "  1. Go to: ${CYAN}https://developer.spotify.com/dashboard${NC}"
    echo -e "  2. Log in with your Spotify account"
    echo -e "  3. Click ${BOLD}Create App${NC}"
    echo -e "  4. Fill in:"
    echo -e "     ‚Ä¢ App name: ${CYAN}cruzalex-spotify${NC}"
    echo -e "     ‚Ä¢ Description: anything"
    echo -e "     ‚Ä¢ Redirect URI: ${CYAN}http://127.0.0.1:8989/login${NC}"
    echo -e "  5. Check ${BOLD}Web API${NC} under APIs"
    echo -e "  6. Click ${BOLD}Create${NC}"
    echo -e "  7. Go to ${BOLD}Settings${NC} and copy your ${BOLD}Client ID${NC}"
    echo ""

    read -p "  Press Enter when you have your Client ID..."
    echo ""

    read -p "  Paste your Client ID: " client_id

    if [ -n "$client_id" ]; then
        # Update the config file
        local config_file="$HOME/.config/spotify-player/app.toml"
        mkdir -p "$(dirname "$config_file")"

        if [ -f "$config_file" ]; then
            # Update existing client_id
            if grep -q "^client_id" "$config_file"; then
                sed -i "s/^client_id = .*/client_id = \"$client_id\"/" "$config_file"
            else
                # Add client_id at the top
                sed -i "1i client_id = \"$client_id\"" "$config_file"
            fi
        else
            # Create minimal config
            cat > "$config_file" << EOF
client_id = "$client_id"

[device]
name = "cruzalex-spotify"
device_type = "computer"
volume = 70

[playback]
backend = "rodio"

[interface]
theme = "cruzalex"
EOF
        fi

        print_success "Client ID saved to $config_file"
        echo ""
        echo -e "  ${BOLD}Step 2: Authenticate${NC}"
        echo ""
        echo -e "  Run ${CYAN}spotify_player${NC} and it will open your browser"
        echo -e "  to authenticate. After that, you're all set!"
        echo ""

        read -p "  Authenticate now? (Y/n) " -n 1 -r
        echo ""
        if [[ ! $REPLY =~ ^[Nn]$ ]]; then
            echo ""
            echo -e "  ${CYAN}Starting spotify_player...${NC}"
            echo -e "  (Check your browser for authentication)"
            echo ""
            spotify_player 2>/dev/null &
            sleep 3
            print_info "spotify_player started in background"
        fi
    else
        print_warning "No Client ID provided, skipping"
    fi

    press_enter
}

# Step 4: Keybindings
step_keybindings() {
    print_header
    print_step "Step 3: Essential Keybindings"

    echo -e "  cruzAlex uses ${BOLD}Super (‚åò/Win)${NC} as the main modifier key."
    echo ""
    echo -e "  ${BOLD}${MAGENTA}‚îÅ‚îÅ‚îÅ Core ‚îÅ‚îÅ‚îÅ${NC}"
    echo -e "  ${CYAN}Super + Space${NC}        App launcher (Walker)"
    echo -e "  ${CYAN}Super + Return${NC}       Terminal (Ghostty)"
    echo -e "  ${CYAN}Super + W${NC}            Close window"
    echo -e "  ${CYAN}Super + Escape${NC}       Power menu"
    echo ""
    echo -e "  ${BOLD}${MAGENTA}‚îÅ‚îÅ‚îÅ Windows ‚îÅ‚îÅ‚îÅ${NC}"
    echo -e "  ${CYAN}Super + Arrows${NC}       Focus window in direction"
    echo -e "  ${CYAN}Super + Shift + Arrows${NC}  Move window"
    echo -e "  ${CYAN}Super + F${NC}            Fullscreen"
    echo -e "  ${CYAN}Super + T${NC}            Toggle floating"
    echo ""
    echo -e "  ${BOLD}${MAGENTA}‚îÅ‚îÅ‚îÅ Workspaces ‚îÅ‚îÅ‚îÅ${NC}"
    echo -e "  ${CYAN}Super + 1-9${NC}          Switch to workspace"
    echo -e "  ${CYAN}Super + Shift + 1-9${NC}  Move window to workspace"
    echo -e "  ${CYAN}Super + Tab${NC}          Next workspace"
    echo ""
    echo -e "  ${BOLD}${MAGENTA}‚îÅ‚îÅ‚îÅ Apps ‚îÅ‚îÅ‚îÅ${NC}"
    echo -e "  ${CYAN}Super + Shift + B${NC}    Browser"
    echo -e "  ${CYAN}Super + Shift + F${NC}    File manager (Yazi)"
    echo -e "  ${CYAN}Super + Shift + M${NC}    Music (Spotify)"
    echo -e "  ${CYAN}Super + Shift + N${NC}    Neovim"
    echo -e "  ${CYAN}Super + Shift + G${NC}    Lazygit"
    echo ""
    echo -e "  ${BOLD}${MAGENTA}‚îÅ‚îÅ‚îÅ Theme ‚îÅ‚îÅ‚îÅ${NC}"
    echo -e "  ${CYAN}Super + Ctrl + Shift + Space${NC}  Theme browser"
    echo -e "  ${CYAN}Super + Ctrl + Space${NC}          Next wallpaper"
    echo ""
    echo -e "  ${BOLD}${MAGENTA}‚îÅ‚îÅ‚îÅ Keyboard Accents (Portuguese) ‚îÅ‚îÅ‚îÅ${NC}"
    echo -e "  ${CYAN}Right Alt + e, vowel${NC}  Acute: √° √© √≠ √≥ √∫"
    echo -e "  ${CYAN}Right Alt + i, vowel${NC}  Circumflex: √¢ √™ √Æ √¥ √ª"
    echo -e "  ${CYAN}Right Alt + n, letter${NC} Tilde: √£ √µ √±"
    echo -e "  ${CYAN}Right Alt + c${NC}         Cedilla: √ß"

    press_enter
}

# Step 5: Summary
step_summary() {
    print_header
    print_step "Setup Complete!"

    echo -e "  Your cruzAlex environment is ready!"
    echo ""
    echo -e "  ${BOLD}Quick tips:${NC}"
    echo ""
    echo -e "  ‚Ä¢ Press ${CYAN}Super + Space${NC} to launch apps"
    echo -e "  ‚Ä¢ Press ${CYAN}Super + K${NC} to see all keybindings"
    echo -e "  ‚Ä¢ Run ${CYAN}cruzalex-themes${NC} to browse 190+ themes"
    echo -e "  ‚Ä¢ Run ${CYAN}cruzalex-menu${NC} for the main control menu"
    echo ""
    echo -e "  ${BOLD}Useful commands:${NC}"
    echo ""
    echo -e "  ${CYAN}cruzalex-theme-set <theme>${NC}  Apply a theme"
    echo -e "  ${CYAN}cruzalex-wallpaper-next${NC}     Change wallpaper"
    echo -e "  ${CYAN}cruzalex-setup${NC}              Run this wizard again"
    echo ""
    echo -e "  ${BOLD}Need help?${NC}"
    echo -e "  ‚Ä¢ GitHub: ${CYAN}github.com/cruzalex/cruzalex-linux-config${NC}"
    echo -e "  ‚Ä¢ Keybindings: ${CYAN}Super + K${NC} or ${CYAN}cruzalex-keybindings${NC}"
    echo ""
    echo -e "  ${GREEN}Enjoy your TUI-first, keyboard-driven Linux! üöÄ${NC}"
    echo ""
}

# Main
main() {
    # Check if running in a terminal
    if [ ! -t 0 ]; then
        echo "This script must be run in an interactive terminal."
        exit 1
    fi

    step_welcome
    step_theme
    step_spotify
    step_keybindings
    step_summary
}

# Run with optional step argument
case "${1:-}" in
    --theme)
        step_theme
        ;;
    --spotify)
        step_spotify
        ;;
    --keys|--keybindings)
        step_keybindings
        ;;
    --help|-h)
        echo "cruzalex-setup - Interactive setup wizard"
        echo ""
        echo "Usage: cruzalex-setup [option]"
        echo ""
        echo "Options:"
        echo "  (none)        Run full wizard"
        echo "  --theme       Theme selection only"
        echo "  --spotify     Spotify setup only"
        echo "  --keys        Show keybindings"
        echo "  --help        Show this help"
        ;;
    *)
        main
        ;;
esac
