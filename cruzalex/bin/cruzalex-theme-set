#!/bin/bash
# cruzalex-theme-set - Apply a theme across all applications
# Usage: cruzalex-theme-set <theme-name>
#
# Follows Omarchy patterns:
# - Atomic symlink updates
# - Parallel hook execution (fire-and-forget)
# - No blocking on IPC operations

CRUZALEX_DIR="${CRUZALEX_DIR:-$HOME/.config/cruzalex}"
THEMES_DIR="$CRUZALEX_DIR/themes"
HOOKS_DIR="$CRUZALEX_DIR/hooks/theme-set.d"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

usage() {
    echo "Usage: cruzalex-theme-set <theme-name>"
    echo ""
    echo "Apply a theme across all configured applications."
    echo ""
    echo "Examples:"
    echo "  cruzalex-theme-set cobalt2"
    echo "  cruzalex-theme-set tokyo-night"
    echo ""
    echo "Available themes:"
    cruzalex-theme-list 2>/dev/null || ls -1 "$THEMES_DIR" 2>/dev/null || echo "  (none installed)"
    exit 1
}

# Check arguments
if [ $# -ne 1 ]; then
    usage
fi

THEME_NAME="$1"
THEME_DIR="$THEMES_DIR/$THEME_NAME"
COLORS_FILE="$THEME_DIR/colors.toml"

# Validate theme exists
if [ ! -d "$THEME_DIR" ]; then
    echo -e "${RED}Error: Theme not found: $THEME_NAME${NC}"
    echo "Available themes:"
    cruzalex-theme-list 2>/dev/null || ls -1 "$THEMES_DIR" 2>/dev/null || echo "  (none)"
    exit 1
fi

# Parse colors.toml and export as environment variables
parse_colors() {
    if [ ! -f "$COLORS_FILE" ]; then
        return
    fi

    # Parse TOML-style color definitions
    while IFS='=' read -r key value; do
        # Skip comments and empty lines
        [[ "$key" =~ ^[[:space:]]*# ]] && continue
        [[ -z "$key" ]] && continue

        # Clean up key and value
        key=$(echo "$key" | tr -d '[:space:]' | tr -d '"')
        value=$(echo "$value" | tr -d '[:space:]' | tr -d '"' | tr -d "'")

        # Export as environment variable
        if [ -n "$key" ] && [ -n "$value" ]; then
            export "THEME_$key"="$value"
        fi
    done < "$COLORS_FILE"
}

echo -e "${GREEN}Applying theme: $THEME_NAME${NC}"

# Export theme info for hooks
export THEME_NAME
export THEME_DIR
export CRUZALEX_DIR

# Parse colors and export
parse_colors

# Update the 'current' symlink atomically
CURRENT_LINK="$CRUZALEX_DIR/current"
NEW_LINK="$CRUZALEX_DIR/.current.new"

ln -sfn "$THEME_DIR" "$NEW_LINK"
mv -T "$NEW_LINK" "$CURRENT_LINK" 2>/dev/null || mv "$NEW_LINK" "$CURRENT_LINK"

# Write current theme name to file (for apps that watch it)
echo "$THEME_NAME" > "$CRUZALEX_DIR/.current-theme"

# Run hook scripts in parallel (fire-and-forget pattern from Omarchy)
# This prevents any single hook from blocking the theme switch
if [ -d "$HOOKS_DIR" ]; then
    echo "  Running hooks..."
    for hook in "$HOOKS_DIR"/*.sh; do
        if [ -x "$hook" ]; then
            hook_name=$(basename "$hook")
            echo -e "    ${YELLOW}â†’${NC} $hook_name"
            # Run each hook in background with timeout
            # Redirect all output to avoid blocking on stdout/stderr
            (
                timeout --kill-after=1 3 "$hook" >/dev/null 2>&1 || true
            ) &
        fi
    done
    # Brief wait for fast hooks, but don't block on slow ones
    sleep 0.3
else
    echo -e "${YELLOW}  No hooks directory found${NC}"
fi

echo -e "${GREEN}Theme applied successfully!${NC}"
